<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Password Vault</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/zxcvbn/4.4.2/zxcvbn.js"></script>
<style>
    :root {
        --bg: #f8f9fa;
        --card-bg: #ffffff;
        --text: #212529;
        --border: #dee2e6;
        --primary: #0d6efd;
        --success: #198754;
        --danger: #dc3545;
        --warning: #ffc107;
        --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg);
        color: var(--text);
        line-height: 1.6;
        padding: 20px;
    }
    .container {
        max-width: 1000px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    .card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 24px;
        border: 1px solid var(--border);
    }
    h1 {
        text-align: center;
        font-size: 2rem;
        margin-bottom: 8px;
        color: #000;
    }
    .subtitle {
        text-align: center;
        color: #555;
        font-size: 0.95rem;
        margin-bottom: 20px;
        line-height: 1.5;
    }
    .form-group {
        margin-bottom: 16px;
    }
    label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 0.95rem;
    }
    input, textarea {
        width: 100%;
        padding: 12px;
        border: 1.5px solid var(--border);
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        transition: border 0.2s;
    }
    input:focus, textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(13,110,253,0.15);
    }
    textarea { min-height: 120px; resize: vertical; }
    button {
        cursor: pointer;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }
    .btn-primary {
        background: #000;
        color: #fff;
    }
    .btn-primary:hover { background: #333; }
    .btn-success {
        background: var(--success);
        color: #fff;
    }
    .btn-success:hover { background: #146c43; }
    .btn-outline {
        background: transparent;
        border: 1.5px solid #000;
        color: #000;
    }
    .btn-outline:hover {
        background: #000;
        color: #fff;
    }
    .btn-small {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
    .input-group {
        position: relative;
    }
    .input-group .btn {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
    }
    .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
    }
    .flex-between {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }
    .flex-center {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-top: 16px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 0.95rem;
    }
    th {
        background: #f1f3f5;
        text-align: left;
        padding: 12px;
        border-bottom: 2px solid var(--border);
        font-weight: 600;
    }
    td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
    }
    .password-cell, .decrypt-password-cell {
        font-family: 'Courier New', monospace;
        position: relative;
    }
    .password-text, .decrypt-password-text {
        letter-spacing: 1px;
    }
    .copy-btn, .password-toggle,
    .decrypt-copy-btn, .decrypt-password-toggle {
        font-size: 0.8rem;
        padding: 4px 8px;
        margin-left: 6px;
    }
    .copy-btn, .decrypt-copy-btn {
        background: #e9ecef;
        display: none;
    }
    .output {
        background: #f8f9fa;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
        font-family: monospace;
        max-height: 300px;
        overflow: auto;
        display: none;
    }
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-1 { margin-top: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .github-card {
        border-left: 4px solid var(--primary);
    }
    .token-status, .master-status {
        font-size: 0.85rem;
        margin-top: 8px;
        color: #555;
    }
    .token-saved, .master-saved { color: var(--success); }
    .token-notsaved, .master-notsaved { color: var(--warning); }
    .action-bar {
        display: flex;
        justify-content: center;
        gap: 16px;
        flex-wrap: wrap;
        padding: 16px 0;
    }
    .info {
        font-size: 0.85rem;
        color: #666;
    }
    .file-list {
        margin-top: 16px;
    }
    .decrypt-file-btn {
        background: var(--primary);
        color: white;
        font-size: 0.8rem;
        padding: 6px 10px;
    }
    .decrypt-file-btn:hover {
        background: #0b5ed7;
    }
    .strength-meter {
        height: 4px;
        background: #eee;
        border-radius: 2px;
        overflow: hidden;
        transition: all 0.3s;
        margin-top: 6px;
    }
    .strength-meter > div {
        height: 100%;
        width: 0%;
        transition: width 0.3s, background 0.3s;
    }
    .strength-0 { background: #dc3545; }
    .strength-1 { background: #fd7e14; }
    .strength-2 { background: #ffc107; }
    .strength-3 { background: #28a745; }
    .strength-4 { background: #007bff; }
    @media (max-width: 768px) {
        .grid-3 { grid-template-columns: 1fr; }
        .flex-between { flex-direction: column; align-items: stretch; }
        .subtitle { font-size: 0.9rem; }
    }
</style>
</head>
<body>
<div class="container">

    <!-- 1. Header -->
    <div class="card text-center">
        <h1>Secure Password Vault</h1>
        <p class="subtitle">
            GitHub is used by over 100 million developers globally, a milestone achieved two years ahead of the company's original 2025 target.<br>
            The platform hosts more than 330 million repositories and is utilized by 90% of Fortune 100 companies.
        </p>
    </div>

    <!-- 2. Master Password Card -->
    <div class="card">
        <div class="form-group">
            <label for="masterPassword">Master Password</label>
            <div class="input-group">
                <input type="password" id="masterPassword" placeholder="Used for encryption & decryption">
                <button id="toggleMaster" class="btn btn-outline btn-small">Show</button>
                <button id="copyMaster" class="btn btn-secondary btn-small copy-btn">Copy</button>
            </div>
            <div id="masterStrength" class="strength-meter"><div></div></div>
            <div id="masterStatus" class="master-status master-notsaved">
                Master password not saved.
            </div>
        </div>
        <div class="form-group">
            <label for="saveKey">Save Key (to unlock saved password)</label>
            <input type="password" id="saveKey" placeholder="Enter a strong save key">
            <div id="saveKeyStrength" class="strength-meter"><div></div></div>
        </div>
        <div class="flex-center">
            <button id="genMaster" class="btn btn-outline">Generate Strong Master</button>
            <button id="saveMasterBtn" class="btn btn-success">Save Master Securely</button>
            <button id="clearMasterBtn" class="btn btn-outline">Clear Saved</button>
        </div>
    </div>

    <!-- 3. Mode Tabs -->
    <div class="card action-bar">
        <button id="tabEncrypt" class="btn btn-primary">Encrypt Mode</button>
        <button id="tabDecrypt" class="btn btn-outline">Decrypt Mode</button>
    </div>

    <!-- 4. ENCRYPT MODE -->
    <div id="encryptMode">
        <div class="card">
            <h3>Add New Entry</h3>
            <div class="grid-3">
                <div class="form-group">
                    <label for="website">Website</label>
                    <input type="text" id="website" placeholder="example.com">
                </div>
                <div class="form-group">
                    <label for="login">Login / Email</label>
                    <input type="text" id="login" placeholder="user@example.com">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <div class="input-group">
                        <input type="password" id="password" placeholder="••••••••">
                        <button id="genPass" class="btn btn-outline btn-small">Gen</button>
                    </div>
                </div>
            </div>
            <div class="flex-center mt-1">
                <button id="addEntry" class="btn btn-primary">Add Entry</button>
            </div>
        </div>

        <div class="card">
            <table id="entryTable">
                <thead>
                    <tr>
                        <th>Website</th>
                        <th>Login</th>
                        <th>Password</th>
                        <th style="width:160px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div id="encryptOutput" class="output">
                <strong>Encrypted Data (Base64):</strong><br>
                <span id="encryptedText" style="word-break:break-all;"></span>
                <div class="flex-center" style="margin-top:12px;">
                    <button id="copyEncrypted" class="btn btn-outline">Copy</button>
                    <button id="downloadEnc" class="btn btn-outline">Download .txt</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="flex-between">
                <button id="encryptDownloadBtn" class="btn btn-success">Encrypt & Download</button>
                <button id="encryptGithubBtn" class="btn btn-success">Encrypt & GitHub Upload</button>
                <button id="clearAll" class="btn btn-outline">Clear All</button>
            </div>
        </div>
    </div>

    <!-- 5. DECRYPT MODE -->
    <div id="decryptMode" class="hidden">
        <div class="card">
            <h3>Decrypt from GitHub</h3>
            <div class="grid-3">
                <div class="form-group">
                    <label for="githubUser">GitHub User / Org</label>
                    <input type="text" id="githubUser" placeholder="your-username">
                </div>
                <div class="form-group">
                    <label for="githubRepo">Repository</label>
                    <input type="text" id="githubRepo" placeholder="my-vault">
                </div>
                <div class="form-group">
                    <label for="githubDir">Directory Path</label>
                    <input type="text" id="githubDir" value="uploads/credentials" placeholder="folder/to/list">
                </div>
            </div>
            <div class="flex-center">
                <button id="loadFilesBtn" class="btn btn-primary">Load Files from GitHub</button>
            </div>

            <div id="fileListSection" class="file-list hidden">
                <table id="fileListTable">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Size</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="mt-1">
                <h4 style="margin:16px 0 8px;">Or Paste Encrypted Data</h4>
                <textarea id="encryptedInput" placeholder="Paste your encrypted Base64 string here..."></textarea>
                <div class="flex-center mt-1">
                    <button id="decryptBtn" class="btn btn-success">Decrypt & View</button>
                    <button id="clearDecrypt" class="btn btn-outline">Clear</button>
                </div>
            </div>

            <div id="decryptOutput" class="output">
                <strong id="decTitle">Decrypted CSV:</strong><br>
                <pre id="csvText" style="display:none;"></pre>
                <div class="flex-center">
                    <button id="downloadCsv" class="btn btn-outline">Download CSV</button>
                </div>
            </div>

            <table id="decryptTable" style="margin-top:20px;display:none;">
                <thead>
                    <tr>
                        <th>Website</th>
                        <th>Login</th>
                        <th>Password</th>
                        <th style="width:140px;">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- 6. GitHub Sync -->
    <div class="card github-card" id="githubSection" style="display:none;">
        <h3 style="margin-bottom:16px;">GitHub Upload</h3>
        <div class="form-group">
            <label for="githubToken">GitHub Token (repo scope)</label>
            <div class="input-group">
                <input type="password" id="githubToken" placeholder="ghp_...">
                <button id="toggleToken" class="btn btn-outline btn-small">Show</button>
            </div>
            <div id="tokenStatus" class="token-status token-notsaved">
                Token not saved. Enter and save.
            </div>
        </div>
        <div class="form-group">
            <label for="githubPath">File Path</label>
            <input type="text" id="githubPath" value="uploads/credentials/vault.csv" placeholder="path/to/vault.csv">
        </div>
        <div class="flex-center mt-1">
            <button id="saveToken" class="btn btn-outline">Save Token Securely</button>
            <button id="clearToken" class="btn btn-outline">Clear Saved Token</button>
        </div>
        <p class="info">
            File will be saved at:<br>
            <code id="previewPath">uploads/credentials/vault.csv</code>
        </p>
    </div>
    <div class="flex-center">
        <button id="toggleGithub" class="btn btn-outline">Toggle GitHub Sync</button>
    </div>

</div>

<script>
/* ---------- CONFIG ---------- */
const PBKDF2_ITERATIONS = 200000;
const KEY_LEN = 32;
const SALT_LEN = 16;
const IV_LEN = 12;
const TAG_LEN = 16;
const GITHUB_BRANCH = 'main';
const GITHUB_COMMIT_MESSAGE = 'Update encrypted vault (CSV)';

/* ---------- INDEXEDDB ---------- */
let db;
const DB_NAME = 'PasswordVaultDB';
const DB_VERSION = 2;
const STORE_NAME = 'vaultSecrets';

function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = e => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };
        req.onsuccess = e => { db = e.target.result; resolve(db); };
        req.onerror = e => reject(e.target.error);
    });
}
let dbReady = openDB();

/* ---------- DOM ---------- */
const masterPassInp   = document.getElementById('masterPassword');
const saveKeyInp      = document.getElementById('saveKey');
const toggleMasterBtn = document.getElementById('toggleMaster');
const copyMasterBtn   = document.getElementById('copyMaster');
const genMasterBtn    = document.getElementById('genMaster');
const saveMasterBtn   = document.getElementById('saveMasterBtn');
const clearMasterBtn  = document.getElementById('clearMasterBtn');
const masterStatus    = document.getElementById('masterStatus');

const tabEncrypt      = document.getElementById('tabEncrypt');
const tabDecrypt      = document.getElementById('tabDecrypt');
const encryptMode     = document.getElementById('encryptMode');
const decryptMode     = document.getElementById('decryptMode');

const websiteInp = document.getElementById('website');
const loginInp   = document.getElementById('login');
const passInp    = document.getElementById('password');
const genPassBtn = document.getElementById('genPass');
const addBtn     = document.getElementById('addEntry');
const tableBody  = document.querySelector('#entryTable tbody');
const encOut     = document.getElementById('encryptOutput');
const encText    = document.getElementById('encryptedText');
const copyEncBtn = document.getElementById('copyEncrypted');
const dlEncBtn   = document.getElementById('downloadEnc');

const encryptDownloadBtn = document.getElementById('encryptDownloadBtn');
const encryptGithubBtn   = document.getElementById('encryptGithubBtn');
const clearAllBtn     = document.getElementById('clearAll');

const encInput   = document.getElementById('encryptedInput');
const decryptBtn = document.getElementById('decryptBtn');
const clearDecBtn= document.getElementById('clearDecrypt');
const decOut     = document.getElementById('decryptOutput');
const decTitle   = document.getElementById('decTitle');
const csvPre     = document.getElementById('csvText');
const dlCsvBtn   = document.getElementById('downloadCsv');
const decTable   = document.getElementById('decryptTable');
const decTBody   = decTable.querySelector('tbody');

const loadFilesBtn = document.getElementById('loadFilesBtn');
const fileListSection = document.getElementById('fileListSection');
const fileListTable = document.getElementById('fileListTable').querySelector('tbody');

const githubUserInp = document.getElementById('githubUser');
const githubRepoInp = document.getElementById('githubRepo');
const githubDirInp  = document.getElementById('githubDir');
const githubTokenInp = document.getElementById('githubToken');
const githubPathInp = document.getElementById('githubPath');
const previewPath   = document.getElementById('previewPath');

const toggleGithubBtn = document.getElementById('toggleGithub');
const githubSection   = document.getElementById('githubSection');
const toggleTokenBtn  = document.getElementById('toggleToken');
const saveTokenBtn    = document.getElementById('saveToken');
const clearTokenBtn   = document.getElementById('clearToken');
const tokenStatus     = document.getElementById('tokenStatus');

/* ---------- STATE ---------- */
let entries = [];
let savedMasterEncrypted = null;
let savedTokenEncrypted = null;
let passwordHideTimer = null;

/* ---------- UTILS ---------- */
function escHTML(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function genStrong(len=16){
    const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
    const arr = new Uint8Array(len);
    crypto.getRandomValues(arr);
    return Array.from(arr,x=>chars[x%chars.length]).join('');
}
async function copy(txt){
    try{await navigator.clipboard.writeText(txt);return true;}
    catch(e){console.error(e);return false;}
}
function updatePreviewPath() {
    const user = githubUserInp.value.trim();
    const repo = githubRepoInp.value.trim();
    const path = githubPathInp.value.trim();
    if (user && repo && path) {
        previewPath.textContent = `${user}/${repo}/blob/${GITHUB_BRANCH}/${path}`;
    } else {
        previewPath.textContent = 'Enter user, repo, and path';
    }
}

/* ---------- SECURITY HARDENING ---------- */
function updateStrength(input, meterId, minScore = 3) {
    const val = input.value;
    const result = zxcvbn(val);
    const meter = document.querySelector(`#${meterId} > div`);
    meter.className = `strength-${result.score}`;
    meter.style.width = `${(result.score + 1) * 20}%`;
    return result.score >= minScore;
}

function autoHidePassword(toggleBtn, textSpan, copyBtn, original = '••••••••') {
    clearTimeout(passwordHideTimer);
    passwordHideTimer = setTimeout(() => {
        if (toggleBtn.textContent === 'Hide') {
            textSpan.textContent = original;
            toggleBtn.textContent = 'Show';
            copyBtn.style.display = 'none';
        }
    }, 10000);
}

function isIncognito() {
    return new Promise((resolve) => {
        const fs = window.RequestFileSystem || window.webkitRequestFileSystem;
        if (!fs) { resolve(false); return; }
        fs(window.TEMPORARY, 100, () => resolve(false), () => resolve(true));
    });
}

/* ---------- SECURE STORAGE ---------- */
async function encryptData(data, password) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const key = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
        await crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']),
        { name: 'AES-GCM', length: 256 }, false, ['encrypt']
    );
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, new TextEncoder().encode(data));
    const encrypted = new Uint8Array(salt.byteLength + iv.byteLength + ct.byteLength);
    encrypted.set(salt, 0);
    encrypted.set(iv, salt.byteLength);
    encrypted.set(new Uint8Array(ct), salt.byteLength + iv.byteLength);
    return btoa(String.fromCharCode(...encrypted));
}
async function decryptData(encryptedB64, password) {
    const bin = Uint8Array.from(atob(encryptedB64), c => c.charCodeAt(0));
    const salt = bin.slice(0, 16);
    const iv = bin.slice(16, 28);
    const ct = bin.slice(28);
    const key = await crypto.subtle.deriveKey(
        { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
        await crypto.subtle.importKey('raw', new TextEncoder().encode(password), 'PBKDF2', false, ['deriveKey']),
        { name: 'AES-GCM', length: 256 }, false, ['decrypt']
    );
    const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
    return new TextDecoder().decode(pt);
}

/* ---------- MASTER & TOKEN ---------- */
async function saveMasterSecurely() {
    const master = masterPassInp.value;
    const key = saveKeyInp.value;
    if (!master || !key) return alert('Enter both master password and save key');
    if (!updateStrength(saveKeyInp, 'saveKeyStrength', 3)) return alert('Save key too weak! Use at least score 3.');
    try {
        const encrypted = await encryptData(master, key);
        const db = await dbReady;
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put({ id: 'master', data: encrypted });
        await tx.done;
        savedMasterEncrypted = encrypted;
        masterStatus.textContent = 'Master password saved securely!';
        masterStatus.className = 'master-status master-saved';
    } catch (e) { alert('Save failed: ' + e.message); }
}
async function loadMasterSecurely() {
    const key = saveKeyInp.value;
    if (!key) return;
    try {
        const db = await dbReady;
        const tx = db.transaction(STORE_NAME, 'readonly');
        const req = tx.objectStore(STORE_NAME).get('master');
        req.onsuccess = async () => {
            if (req.result) {
                try {
                    const decrypted = await decryptData(req.result.data, key);
                    masterPassInp.value = decrypted;
                    savedMasterEncrypted = req.result.data;
                    masterStatus.textContent = 'Master password loaded';
                    masterStatus.className = 'master-status master-saved';
                    loadTokenFromDB();
                } catch (e) {
                    masterStatus.textContent = 'Wrong save key';
                    masterStatus.className = 'master-status master-notsaved';
                }
            }
        };
    } catch (e) { console.error(e); }
}
async function clearSavedMaster() {
    if (!confirm('Delete saved master password?')) return;
    try {
        const db = await dbReady;
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).delete('master');
        await tx.done;
        savedMasterEncrypted = null;
        masterPassInp.value = '';
        masterStatus.textContent = 'Saved master cleared';
        masterStatus.className = 'master-status master-notsaved';
    } catch (e) { alert('Clear failed'); }
}
saveMasterBtn.onclick = saveMasterSecurely;
clearMasterBtn.onclick = clearSavedMaster;
saveKeyInp.addEventListener('input', () => {
    updateStrength(saveKeyInp, 'saveKeyStrength', 3);
    loadMasterSecurely();
});

async function saveTokenToDB() {
    const token = githubTokenInp.value.trim();
    const master = masterPassInp.value;
    if (!token || !master) return alert('Enter token and master password');
    try {
        const encrypted = await encryptData(token, master);
        const db = await dbReady;
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).put({ id: 'github', data: encrypted });
        await tx.done;
        savedTokenEncrypted = encrypted;
        tokenStatus.textContent = 'Token saved securely!';
        tokenStatus.className = 'token-status token-saved';
    } catch (e) { alert('Save failed: ' + e.message); }
}
async function loadTokenFromDB() {
    const master = masterPassInp.value;
    if (!master) return;
    try {
        const db = await dbReady;
        const tx = db.transaction(STORE_NAME, 'readonly');
        const req = tx.objectStore(STORE_NAME).get('github');
        req.onsuccess = async () => {
            if (req.result) {
                try {
                    const decrypted = await decryptData(req.result.data, master);
                    githubTokenInp.value = decrypted;
                    savedTokenEncrypted = req.result.data;
                    tokenStatus.textContent = 'Token loaded';
                    tokenStatus.className = 'token-status token-saved';
                } catch (e) {
                    tokenStatus.textContent = 'Wrong master password';
                    tokenStatus.className = 'token-status token-notsaved';
                }
            }
        };
    } catch (e) { console.error(e); }
}
async function clearSavedToken() {
    if (!confirm('Delete saved token?')) return;
    try {
        const db = await dbReady;
        const tx = db.transaction(STORE_NAME, 'readwrite');
        tx.objectStore(STORE_NAME).delete('github');
        await tx.done;
        savedTokenEncrypted = null;
        githubTokenInp.value = '';
        tokenStatus.textContent = 'Token cleared';
        tokenStatus.className = 'token-status token-notsaved';
    } catch (e) { alert('Clear failed'); }
}
saveTokenBtn.onclick = saveTokenToDB;
clearTokenBtn.onclick = clearSavedToken;

/* ---------- GITHUB API ---------- */
async function getToken() {
    let token = githubTokenInp.value.trim();
    if (!token && savedTokenEncrypted) {
        try { token = await decryptData(savedTokenEncrypted, masterPassInp.value); }
        catch { alert('Failed to decrypt saved token'); return null; }
    }
    return token;
}

async function listFilesInDirectory(user, repo, path, token) {
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}?ref=${GITHUB_BRANCH}`;
    const res = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json' }
    });
    if (!res.ok) throw new Error(`GitHub error: ${res.status}`);
    const files = await res.json();
    return files.filter(f => f.name.endsWith('.csv') && f.type === 'file');
}

async function downloadFile(user, repo, path, token) {
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}?ref=${GITHUB_BRANCH}`;
    const res = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json' }
    });
    if (!res.ok) throw new Error(`Download failed: ${res.status}`);
    const data = await res.json();
    const content = atob(data.content.replace(/\s/g, ''));
    return content.match(/"([^"]+)"/)[1];
}

/* ---------- DECRYPT FROM GITHUB ---------- */
loadFilesBtn.onclick = async () => {
    const user = githubUserInp.value.trim();
    const repo = githubRepoInp.value.trim();
    const dir = githubDirInp.value.trim();
    const token = await getToken();
    if (!user || !repo || !dir || !token) return alert('Fill all GitHub fields and token');

    fileListTable.innerHTML = '<tr><td colspan="3">Loading...</td></tr>';
    fileListSection.classList.remove('hidden');

    try {
        const files = await listFilesInDirectory(user, repo, dir, token);
        fileListTable.innerHTML = '';
        if (files.length === 0) {
            fileListTable.innerHTML = '<tr><td colspan="3">No CSV files found.</td></tr>';
            return;
        }
        files.forEach(file => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${escHTML(file.name)}</td>
                <td>${file.size} bytes</td>
                <td><button class="btn decrypt-file-btn" data-path="${file.path}">Decrypt</button></td>
            `;
            tr.querySelector('.decrypt-file-btn').onclick = () => decryptGitHubFile(file.path, user, repo, token);
            fileListTable.appendChild(tr);
        });
    } catch (e) {
        fileListTable.innerHTML = `<tr><td colspan="3">Error: ${e.message}</td></tr>`;
    }
};

async function decryptGitHubFile(path, user, repo, token) {
    const mp = masterPassInp.value;
    if (!mp) return alert('Enter master password');
    decTitle.textContent = 'Decrypting...';
    decOut.style.display = 'block';
    try {
        const base64 = await downloadFile(user, repo, path, token);
        const csv = await decryptDataVault(base64, mp);
        showDecrypted(csv);
    } catch (e) {
        decTitle.textContent = 'Failed';
        csvPre.textContent = e.message;
    }
}

/* ---------- ENCRYPT/DECRYPT VAULT ---------- */
function addRow(w,l,p){
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td>${escHTML(w)}</td>
        <td>${escHTML(l)}</td>
        <td class="password-cell"><span class="password-text">••••••••</span><button class="btn btn-outline btn-small copy-btn">Copy</button></td>
        <td>
            <button class="btn btn-outline btn-small password-toggle" data-pwd="${escHTML(p)}">Show</button>
            <button class="btn btn-outline btn-small" style="background:#dc3545;color:#fff;" onclick="this.closest('tr').remove();syncEntries();">Delete</button>
        </td>`;
    const toggleBtn = tr.querySelector('.password-toggle');
    const textSpan = tr.querySelector('.password-text');
    const copyBtn = tr.querySelector('.copy-btn');
    toggleBtn.onclick = () => {
        if (toggleBtn.textContent === 'Show') {
            textSpan.textContent = toggleBtn.dataset.pwd;
            toggleBtn.textContent = 'Hide';
            copyBtn.style.display = 'inline-flex';
        } else {
            textSpan.textContent = '••••••••';
            toggleBtn.textContent = 'Show';
            copyBtn.style.display = 'none';
        }
        autoHidePassword(toggleBtn, textSpan, copyBtn);
    };
    copyBtn.onclick = async () => {
        if (await copy(toggleBtn.dataset.pwd)) {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => copyBtn.textContent = 'Copy', 1500);
            alert('Password copied! It will auto-hide in 10s.');
        }
    };
    tableBody.appendChild(tr);
    syncEntries();
}
function syncEntries(){
    entries = Array.from(tableBody.rows).map(r => {
        const t = r.cells[3].querySelector('.password-toggle');
        return {website: r.cells[0].textContent, login: r.cells[1].textContent, password: t.dataset.pwd};
    });
}
function makeCSV(){
    if (!entries.length) return '';
    let csv = 'Website,Login,Password\n';
    entries.forEach(e => csv += `"${e.website.replace(/"/g,'""')}","${e.login.replace(/"/g,'""')}","${e.password.replace(/"/g,'""')}"\n`);
    return csv;
}
async function encryptDataVault(plain, pwd){
    const salt = crypto.getRandomValues(new Uint8Array(SALT_LEN));
    const iv = crypto.getRandomValues(new Uint8Array(IV_LEN));
    const key = await crypto.subtle.deriveKey(
        {name:'PBKDF2',salt,iterations:PBKDF2_ITERATIONS,hash:'SHA-256'},
        await crypto.subtle.importKey('raw', new TextEncoder().encode(pwd), 'PBKDF2', false, ['deriveKey']),
        {name:'AES-GCM',length:KEY_LEN*8}, false, ['encrypt']
    );
    const ct = await crypto.subtle.encrypt({name:'AES-GCM',iv}, key, new TextEncoder().encode(plain));
    const arr = new Uint8Array(ct);
    const tag = arr.slice(-TAG_LEN), enc = arr.slice(0,-TAG_LEN);
    const out = new Uint8Array(SALT_LEN+IV_LEN+TAG_LEN+enc.length);
    out.set(salt,0); out.set(iv,SALT_LEN); out.set(tag,SALT_LEN+IV_LEN); out.set(enc,SALT_LEN+IV_LEN+TAG_LEN);
    return btoa(String.fromCharCode(...out));
}
async function decryptDataVault(b64,pwd){
    const bin = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
    const salt = bin.slice(0,SALT_LEN), iv = bin.slice(SALT_LEN,SALT_LEN+IV_LEN);
    const tag = bin.slice(SALT_LEN+IV_LEN,SALT_LEN+IV_LEN+TAG_LEN), ct = bin.slice(SALT_LEN+IV_LEN+TAG_LEN);
    const key = await crypto.subtle.deriveKey(
        {name:'PBKDF2',salt,iterations:PBKDF2_ITERATIONS,hash:'SHA-256'},
        await crypto.subtle.importKey('raw', new TextEncoder().encode(pwd), 'PBKDF2', false, ['deriveKey']),
        {name:'AES-GCM',length:KEY_LEN*8}, false, ['decrypt']
    );
    const full = new Uint8Array(ct.length + TAG_LEN); full.set(ct,0); full.set(tag,ct.length);
    return new TextDecoder().decode(await crypto.subtle.decrypt({name:'AES-GCM',iv}, key, full));
}

function showDecrypted(csv) {
    decTitle.textContent = 'Decrypted CSV:';
    csvPre.textContent = csv;
    const lines = csv.trim().split('\n');
    if (lines.length < 2) {
        decTable.style.display = 'none';
        csvPre.style.display = 'block';
        return;
    }

    const tbody = decTable.querySelector('tbody');
    tbody.innerHTML = '';
    for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',').map(s => s.replace(/^"|"$/g, '').replace(/""/g, '"'));
        if (cols.length < 3) continue;
        const [w, l, p] = cols;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${escHTML(w)}</td>
            <td>${escHTML(l)}</td>
            <td class="decrypt-password-cell">
                <span class="decrypt-password-text">••••••••</span>
                <button class="btn btn-outline btn-small decrypt-copy-btn">Copy</button>
            </td>
            <td>
                <button class="btn btn-outline btn-small decrypt-password-toggle" data-pwd="${escHTML(p)}">Show</button>
            </td>
        `;

        const toggleBtn = tr.querySelector('.decrypt-password-toggle');
        const copyBtn = tr.querySelector('.decrypt-copy-btn');
        const textSpan = tr.querySelector('.decrypt-password-text');

        toggleBtn.onclick = () => {
            if (toggleBtn.textContent === 'Show') {
                textSpan.textContent = p;
                toggleBtn.textContent = 'Hide';
                copyBtn.style.display = 'inline-flex';
            } else {
                textSpan.textContent = '••••••••';
                toggleBtn.textContent = 'Show';
                copyBtn.style.display = 'none';
            }
            autoHidePassword(toggleBtn, textSpan, copyBtn);
        };

        copyBtn.onclick = async () => {
            if (await copy(p)) {
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 1500);
                alert('Password copied! It will auto-hide in 10s.');
            }
        };

        tbody.appendChild(tr);
    }
    decTable.style.display = 'table';
    csvPre.style.display = 'none';
}

/* ---------- EVENTS ---------- */
genMasterBtn.onclick = () => { const p=genStrong(20); masterPassInp.value=p; masterPassInp.type='text'; toggleMasterBtn.textContent='Hide'; copyMasterBtn.style.display='inline-flex'; alert('Generated:\n'+p); };
genPassBtn.onclick = () => passInp.value = genStrong();
addBtn.onclick = () => { const w=websiteInp.value.trim(), l=loginInp.value.trim(), p=passInp.value; if(!w||!l||!p) return alert('Fill all'); addRow(w,l,p); websiteInp.value=loginInp.value=passInp.value=''; };

toggleMasterBtn.onclick = () => {
    if (masterPassInp.type === 'password') {
        masterPassInp.type = 'text';
        toggleMasterBtn.textContent = 'Hide';
        copyMasterBtn.style.display = 'inline-flex';
    } else {
        masterPassInp.type = 'password';
        toggleMasterBtn.textContent = 'Show';
        copyMasterBtn.style.display = 'none';
    }
    autoHidePassword(toggleMasterBtn, masterPassInp, copyMasterBtn, masterPassInp.value);
};

copyMasterBtn.onclick = async () => {
    if (await copy(masterPassInp.value)) {
        copyMasterBtn.textContent = 'Copied!';
        setTimeout(() => copyMasterBtn.textContent = 'Copy', 1500);
    }
};

masterPassInp.addEventListener('input', () => {
    updateStrength(masterPassInp, 'masterStrength', 2);
    if (masterPassInp.value.length > 0) loadTokenFromDB();
});

async function doEncrypt() {
    const mp = masterPassInp.value;
    if (!mp || !entries.length) return alert('Enter master password and add entries');
    const enc = await encryptDataVault(makeCSV(), mp);
    encText.textContent = enc;
    encOut.style.display = 'block';
}

encryptDownloadBtn.onclick = doEncrypt;
encryptGithubBtn.onclick = async () => {
    await doEncrypt();
    if (!encText.textContent) return;
    const token = await getToken();
    const user = githubUserInp.value.trim();
    const repo = githubRepoInp.value.trim();
    const path = githubPathInp.value.trim();
    if (!token || !user || !repo || !path) return alert('Fill all GitHub fields!');
    await uploadToGitHubAsCSV(encText.textContent, user, repo, path, token);
};

async function uploadToGitHubAsCSV(encryptedBase64, user, repo, path, token) {
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
    const headers = { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json', 'X-GitHub-Api-Version': '2022-11-28' };
    const csvContent = `"${encryptedBase64}"`;
    const base64Content = btoa(unescape(encodeURIComponent(csvContent)));

    try {
        const getRes = await fetch(url, { headers });
        let body;
        if (getRes.status === 404) {
            body = { message: GITHUB_COMMIT_MESSAGE, content: base64Content, branch: GITHUB_BRANCH };
        } else if (getRes.ok) {
            const data = await getRes.json();
            body = { message: GITHUB_COMMIT_MESSAGE, content: base64Content, sha: data.sha, branch: GITHUB_BRANCH };
        } else throw new Error(`GitHub API error: ${getRes.status}`);
        const putRes = await fetch(url, { method: 'PUT', headers, body: JSON.stringify(body) });
        if (putRes.ok) alert(`Uploaded to GitHub!\n${user}/${repo}/blob/${GITHUB_BRANCH}/${path}`);
        else throw new Error(await putRes.text());
    } catch (e) { alert(`Upload failed: ${e.message}`); }
}

clearAllBtn.onclick = () => { if(confirm('Clear all?')) { tableBody.innerHTML=''; entries=[]; encOut.style.display='none'; }};
decryptBtn.onclick = async () => {
    const mp = masterPassInp.value.trim(), d = encInput.value.trim();
    if (!mp || !d) return alert('Enter master password and paste data');
    decOut.style.display = 'block'; decTitle.textContent = 'Decrypting...';
    try { showDecrypted(await decryptDataVault(d, mp)); }
    catch (e) { decTitle.textContent = 'Failed'; csvPre.textContent = e.message; }
};
clearDecBtn.onclick = () => { if(confirm('Clear?')) { encInput.value=''; decOut.style.display='none'; decTable.style.display='none'; fileListSection.classList.add('hidden'); }};
dlCsvBtn.onclick = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csvPre.textContent],{type:'text/csv'})); a.download='decrypted.csv'; a.click(); };

copyEncBtn.onclick = () => copy(encText.textContent).then(() => { copyEncBtn.textContent='Copied!'; setTimeout(() => copyEncBtn.textContent='Copy',1500); });
dlEncBtn.onclick = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([encText.textContent],{type:'text/plain'})); a.download='vault.txt'; a.click(); };

toggleGithubBtn.onclick = () => githubSection.style.display = githubSection.style.display === 'none' ? 'block' : 'none';

/* TABS */
tabEncrypt.onclick = () => { encryptMode.classList.remove('hidden'); decryptMode.classList.add('hidden'); tabEncrypt.classList.replace('btn-outline','btn-primary'); tabDecrypt.classList.replace('btn-primary','btn-outline'); };
tabDecrypt.onclick = () => { decryptMode.classList.remove('hidden'); encryptMode.classList.add('hidden'); tabDecrypt.classList.replace('btn-outline','btn-primary'); tabEncrypt.classList.replace('btn-primary','btn-outline'); };

/* ENTER & AUTO */
[websiteInp,loginInp,passInp].forEach(i=>i.addEventListener('keydown',e=>e.key==='Enter'&&addBtn.click()));
[githubUserInp, githubRepoInp, githubPathInp].forEach(el => el.addEventListener('input', updatePreviewPath));
updatePreviewPath();

/* INIT */
dbReady.then(() => {
    console.log('DB ready');
    if (saveKeyInp.value) loadMasterSecurely();
    isIncognito().then(isPrivate => {
        if (!isPrivate) {
            const warning = document.createElement('div');
            warning.style.cssText = 'background:#fff3cd;color:#856404;padding:12px;border-radius:8px;margin:16px 0;font-size:0.9rem;border:1px solid #ffeaa7;';
            warning.innerHTML = 'Warning: <strong>Not in Incognito/Private mode</strong>. Your vault may be cached. Use private browsing for max security.';
            document.querySelector('.container').insertBefore(warning, document.querySelector('.card'));
        }
    });
}).catch(err => {
    console.error('DB init failed:', err);
    alert('Database error. Try clearing browser data for this site.');
});
</script>
</body>
</html>